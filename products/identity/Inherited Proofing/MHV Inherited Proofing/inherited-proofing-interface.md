# MHV Inherited Proofing Usage

## Version History
| Version Number | Author                                                 | Revision Date | Description of Change |
|----------------|--------------------------------------------------------|---------------|-----------------------|
| 0.1            | Trevor Bosaw, John Bramley, Josh Scanish, Joe Niquette | 4/7/2022      | Initial Creation      |


## Summary
The solution will enable veterans who have already completed the MHV in person verification process to automatically transition their verification information over to a login.gov account. This will work regardless of their login.gov account status. 

## Description
This document describes how to use the MHV Inherited Proofing VA.gov service. The service enables a client, such as login.gov, to receive a special authentication request from va.gov which includes an authentication code to then request verification information about the currently logged in user. The client will send a signed JWT request with the auth code and expect a JWT back from the VA.gov Inherited Proofing service. This JWT must be decrypted with the clients private key. Formal registration of the public private key pairs should be completed during the initial development phase of the project, with preference being given to public registered endpoints which share public certificates the client intends to use.

## Diagram
![MHV Inherited Proofing - Technical Flow - API](https://user-images.githubusercontent.com/71290526/162247628-f2d6d307-bae0-4b09-9a87-94795a3430cf.png)


## Authorization
*  Initial browser redirect from `vets-api` to login.gov is a standard OAuth Authorization, with an additional field, `inherited_proofing_auth`:
 ```
https://idp.int.identitysandbox.gov/openid_connect/authorize?acr_values=
http%3A%2F%2Fidmanagement.gov%2Fns%2Fassurance%2Fial%2F2&client_id=
${CLIENT_ID}&nonce=${NONCE}&prompt=select_account&redirect_uri=
${REDIRECT_URI}&response_type=code&scope=
profile+email+openid+social_security_number&state=${STATE}&inherited_proofing_auth=
${AUTH_CODE}
```

* `AUTH_CODE` is a 32 character hexadecimal random string that is generated by `vets-api` for each inherited proofing attempt
* `REDIRECT_URI` is a redirect to the specific inherited proofing callback, one of:
	* `localhost:3000/inherited_proofing/callback`
	* `https://api.va.gov/inherited_proofing/callback`
	* `https://staging-api.va.gov/inherited_proofing/callback`
	* `https://staging-api.va.gov/review_instance/inherited_proofing/callback`
	* `https://dev-api.va.gov/inherited_proofing/callback`
* `NONCE` is a 32 character hexadecimal random string generated by `vets-api`
* `STATE` is a 32 character hexadecimal random string generated by `vets-api`
* `CLIENT_ID` is the given value from our login.gov application
* `acr_values` is currently set to `ial2` url, `http://idmanagement.gov/ns/assurance/ial/2`
* `prompt` set to `select_account`, as required
* `response_type` set to `code`, as required
* `scope` set to include `profile email openid social_security_number`

* Once inherited proofing verification is fully complete, the expectation is for login.gov to redirect back to `redirect_uri`, where `vets-api` will log out of current `MHV` authentication, store proof of verification, and redirect back to login.gov for a final, verified authentication (separate from the authentication above)

## User Attributes

### Request

* API from login.gov to `vets-api`, `/inherited_proofing/user_attributes` with JWT  bearer token as authentication:
 ```
curl -X GET https://staging-api.va.gov/inherited_proofing/user_attributes -H ‘Authorization: Bearer
eyJhbGciOiJIUzI1NiJ9.eyJpbmhlcml0ZWRfcHJvb2ZpbmdfYXV0aCI6IjJiYzViZjViOTU1YTg4ZG
Y2ZjNkZTNjNjJjODdmNmYyIn0.HziiPA5EzB_tWhmSizocDfd3E6GyCK4W-nugKwp6HXg’
```
* During the process of inherited proofing, login.gov will call `vets-api` at one of the following to gain verified user attributes:
	* `localhost:3000/inherited_proofing/user_attributes`
	* `https://api.va.gov/inherited_proofing/user_attributes `
	* `https://staging-api.va.gov/inherited_proofing/user_attributes `
	* `https://staging-api.va.gov/review_instance/inherited_proofing/user_attributes `
	* `https://dev-api.va.gov/inherited_proofing/user_attributes `
* API must be called with a JWT, encoded with `inherited_proofing_auth` and `exp` fields, using the login.gov private key:
``` ruby
{ 
inherited_proofing_auth: 
  ${AUTH_CODE}, 
  exp: ${EXPIRATION_TIME} 
} 
```

| Name       | Description                             | Value Type                                              |
|------------|-----------------------------------------|---------------------------------------------------------|
| AUTH_CODE  | 32 character hexadecimal random string from the `authorize` call  |  String, REQUIRED    |
| EXPIRATION_TIME | representing epoch time, for example: `1649276453` | Integer, REQUIRED |

### Response
Response will be an encrypted json web token (JWE), in a simple JSON wrapper:
``` ruby
{ 
  data: 
    ${ENCRYPTED_USER_ATTRIBUTES}
}
```
* `ENCRYPTED_USER_ATTRIBUTES` are user attributes encrypted as a JWE
* To decrypt, use login.gov private key, with `alg: RSA-OAEP`, `enc: A128CBC-HS256`
* When decrypted, user attributes are:
``` ruby
{ 
  first_name: ${FIRST_NAME},
  last_name: ${LAST_NAME},
  address: ${ADDRESS},
  phone: ${PHONE},
  birth_date: ${BIRTH_DATE},
  ssn: ${SSN}
}
```
* `ADDRESS` has format:
``` ruby
{
  street: ${STREET},
  street2: ${STREET 2},
  city: ${CITY},
  state: ${STATE},
  country: ${COUNTRY},
  zip: ${ZIP}
}
```

## `inherited_proofing/user_attributes` Endpoint Parameters

| Name       | Description                             | Value Type                                              |
|------------|-----------------------------------------|---------------------------------------------------------|
| First_name | users first name                        | String, REQUIRED                                        |
| Last_name  | users last name                         | String, REQUIRED                                        |
| Phone      | users phone number                      | String, OPTIONAL                                        |
| Birth_date | users birth date                        | String, REQUIRED,`iso8601` formatted (ex: `2020-01-31`) |
| SSN        | users social security number            | String, REQUIRED                                        |
| Address    | address block of information for user   | JSON Blob, REQUIRED                                     |
| Street     | users street address                    | String, REQUIRED                                        |
| Street 2   | optional sub street address description | String, OPTIONAL                                        |
| City       | users city                              | String, OPTIONAL                                        |
| State      | users state                             | String, OPTIONAL                                        |
| Country    | users country                           | String, OPTIONAL                                        |
| Zip        | users zip code                          | String, REQUIRED                                        |


## Callback
* After login.gov completes inherited proofing successfully, expectation is to call callback described in `redirect_uri` parameter from `/authenticate`
*  As described above, `redirect_uri` can be one of:
	* `localhost:3000/inherited_proofing/callback`
	* `https://api.va.gov/inherited_proofing/callback`
	* `https://staging-api.va.gov/inherited_proofing/callback`
	* `https://staging-api.va.gov/review_instance/inherited_proofing/callback`
	* `https://dev-api.va.gov/inherited_proofing/callback`


