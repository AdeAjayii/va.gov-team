# MHV Inherited Proofing Usage


## Authorization
*  Initial browser redirect from `vets-api` to login.gov is a standard OAuth Authorization, with an additional field, `inherited_proofing_auth`:
	* `https://idp.int.identitysandbox.gov/openid_connect/authorize?acr_values=http%3A%2F%2Fidmanagement.gov%2Fns%2Fassurance%2Fial%2F2&client_id=${CLIENT_ID}&nonce=${NONCE}&prompt=select_account&redirect_uri=${REDIRECT_URI}&response_type=code&scope=profile+email+openid+social_security_number&state=${STATE}&inherited_proofing_auth=${AUTH_CODE}`
		* `AUTH_CODE` is a 32 character hexadecimal random string that is generated by `vets-api` for each inherited proofing attempt
		* `REDIRECT_URI` is a redirect to the specific inherited proofing callback, one of:
			* `localhost:3000/inherited_proofing/callback`
			* `https://api.va.gov/inherited_proofing/callback`
			* `https://staging-api.va.gov/inherited_proofing/callback`
			* `https://staging-api.va.gov/review_instance/inherited_proofing/callback`
			* `https://dev-api.va.gov/inherited_proofing/callback`
		* `NONCE` is a 32 character hexadecimal random string generated by `vets-api`
		* `STATE` is a 32 character hexadecimal random string generated by `vets-api`
		* `CLIENT_ID` is the given value from our login.gov application
		* `acr_values` is currently set to `ial2` url, `http://idmanagement.gov/ns/assurance/ial/2`
		* `prompt` set to `select_account`, as required
		* `response_type` set to `code`, as required
		* `scope` set to include `profile email openid social_security_number`
	* Once inherited proofing verification is fully complete, the expectation is for login.gov to redirect back to `redirect_uri`, where `vets-api` will log out of current `MHV` authentication, store proof of verification, and redirect back to login.gov for a final, verified authentication (separate from the authentication above)

## User Attributes
* API from login.gov to `vets-api`, `/inherited_proofing/user_attributes` with JWT  bearer token as authentication
	* `curl -X GET https://staging-api.va.gov/inherited_proofing/user_attributes -H ‘Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJpbmhlcml0ZWRfcHJvb2ZpbmdfYXV0aCI6IjJiYzViZjViOTU1YTg4ZGY2ZjNkZTNjNjJjODdmNmYyIn0.HziiPA5EzB_tWhmSizocDfd3E6GyCK4W-nugKwp6HXg’`
* During the process of inherited proofing, login.gov will call `vets-api` at one of the following to gain verified user attributes:
	* 	 `localhost:3000/inherited_proofing/user_attributes`
	* `https://api.va.gov/inherited_proofing/user_attributes `
	* `https://staging-api.va.gov/inherited_proofing/user_attributes `
	* `https://staging-api.va.gov/review_instance/inherited_proofing/user_attributes `
		* `https://dev-api.va.gov/inherited_proofing/user_attributes `
* API must be called with a JWT, encoded with `inherited_proofing_auth` and `exp` fields, using the login.gov private key:
	* `{ inherited_proofing_auth: ${AUTH_CODE}, exp: ${EXPIRATION_TIME} }`
		* `AUTH_CODE` is the 32 character hexadecimal random string from the `authorize` call above
		* `EXPIRATION_TIME` is an integer representing epoch time, for example: `1649276453`
* Response will be an encrypted json web token (JWE), in a simple JSON wrapper:
	* `{ data: ${ENCRYPTED_USER_ATTRIBUTES} }`
		* `ENCRYPTED_USER_ATTRIBUTES` are user attributes encrypted as a JWE
* To decrypt, use login.gov private key, with `alg: RSA-OAEP`, `enc: A128CBC-HS256`
* When decrypted, user attributes are:
``` ruby
{ 
  first_name: ${FIRST_NAME},
  last_name: ${LAST_NAME},
  address: ${ADDRESS},
  phone: ${PHONE},
  birth_date: ${BIRTH_DATE},
  ssn: ${SSN}
}
```
* `FIRST_NAME` is a string, *required*
* `LAST_NAME` is a string, *required*
* `PHONE` is a string, *optional*
* `BIRTH_DATE` is a string, `iso8601` formatted (ex: `2020-01-31`), *required*
* `SSN` is a string, *required*
* `ADDRESS` has format:
``` ruby
{
  street: ${STREET},
  street2: ${STREET 2},
  city: ${CITY},
  state: ${STATE},
  country: ${COUNTRY},
  zip: ${ZIP}
}
```
  * `STREET` is a string, *required*
  * `STREET 2` is a string, *optional*
  * `CITY` is a string, *optional*
  * `STATE` is a string, *optional*
  * `COUNTRY` is a string, *optional*
  * `ZIP` is a string, *required*



## Callback
* After login.gov completes inherited proofing successfully, expectation is to call callback described in `redirect_uri` parameter from `/authenticate`
*  As described above, `redirect_uri` can be one of:
	* `localhost:3000/inherited_proofing/callback`
	* `https://api.va.gov/inherited_proofing/callback`
	* `https://staging-api.va.gov/inherited_proofing/callback`
	* `https://staging-api.va.gov/review_instance/inherited_proofing/callback`
	* `https://dev-api.va.gov/inherited_proofing/callback`
